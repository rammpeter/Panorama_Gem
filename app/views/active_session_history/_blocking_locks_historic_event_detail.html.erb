<%
  @update_area            = get_unique_area_id
  @update_area_timechart  = get_unique_area_id

  link_blocking_sessions = proc do |rec|
    "<&nbsp;#{fn(rec.blocking_sessions)}&nbsp;>".html_safe
  end

  link_blocking_session = proc do |rec|
    "#{rec.instance}: #{rec.sid} / #{rec.serialno}"
  end

  link_waiting_sessions = proc do |rec|
    "<&nbsp;#{fn(rec.waiting_sessions)}&nbsp;>".html_safe
  end

  link_waiting_session = proc do |rec|
    "#{rec.instance}: #{rec.sid} / #{rec.serialno}"
  end

  link_column_samples = proc do |rec|
    session_info = case @role
                   when :blocking then {Blocking_Instance: rec.instance, Blocking_Session: rec.sid, Blocking_Session_Serial_No: rec.serialno}
                   when :waiting then  {Instance:          rec.instance, Session_ID:       rec.sid, SerialNo:                   rec.serialno}
                   end
    ajax_link(fn(rec.samples), {
        :action           => :list_session_statistic_historic_single_record,
        :update_area      => @update_area,
        record_count:     rec.samples,
        :groupfilter      => {
            Blocking_Event:           @blocking_event,
            Event:                    @waiting_event,
            DBID:                     @dbid,
            time_selection_start:     @time_selection_start,
            time_selection_end:       @time_selection_end,
        }.merge(session_info)
    }, title: "Show ASH records for this #{@role} session and combination of blocking and waiting event"
    )
  end


  column_options = []
  column_options << {caption: 'Blocking sessions',      data: link_blocking_sessions,             title: 'Number of distinct sessions (Instance, SID, Serial#) that are blocking this session', align: :right } if @role == :waiting
  column_options << {caption: 'Blocking session',       data: link_blocking_session,              title: 'Instance, SID, Serial# of the session that is blocking other sessions' } if @role == :blocking
  column_options << {caption: 'Blocking active (sec.)', data: proc{|rec| fn(rec.blocking_active_seconds) },       title: 'Total number of seconds blocking session(s) have been active (or blocked themself)', data_title: proc{|rec| "%t\n#{seconds_explain(rec.blocking_active_seconds)}"}, align: :right }
  column_options << {caption: 'Waiting sessions',       data: link_waiting_sessions,              title: 'Number of distinct sessions (Instance, SID, Serial#) that are waiting for this session', align: :right } if @role == :blocking
  column_options << {caption: 'Waiting session',        data: link_waiting_session,               title: 'Instance, SID, Serial# of the session that is waiting for a blocking session' } if @role == :waiting
  column_options << {caption: 'Waiting active (sec.)',  data: proc{|rec| fn(rec.waiting_active_seconds) },        title: 'Total number of seconds waiting session(s) have been blocked by blocking sessions', data_title: proc{|rec| "%t\n#{seconds_explain(rec.waiting_active_seconds)}"}, align: :right, show_pct_hint: true, show_pct_background: true}
  column_options << {caption: 'First ASH sample',       data: proc{|rec| localeDateTime(rec.first_occurrence) },  title: 'First occurrence of ASH sample for blocked waiting session'}
  column_options << {caption: 'Last ASH sample',        data: proc{|rec| localeDateTime(rec.last_occurrence) },   title: 'Last occurrence of ASH sample for blocked waiting session'}
  column_options << {caption: 'Samples',                data: link_column_samples,                                title: 'Number of ASH samples for waiting sessions between first and last occurrence of ASH sample', align: :right }
  column_options << {caption: 'Avg. waiting sessions',  data: proc{|rec| fn(rec.avg_waiting_sessions, 1) },       title: 'Average number of waiting sessions between first and last occurrence of ASH sample', align: :right }
  column_options << {caption: 'Avg. ms per wait',       data: proc{|rec| fn(rec.avg_seconds_in_wait*1000, 2) },   title: 'Average time in milliseconds the waiting sessions spent since start of last wait', align: :right }
  column_options << {caption: 'Min. ms per wait',       data: proc{|rec| fn(rec.min_seconds_in_wait*1000, 2) },   title: 'Minimum time in milliseconds a waiting session spent since start of last wait', align: :right }
  column_options << {caption: 'Max. ms per wait',       data: proc{|rec| fn(rec.max_seconds_in_wait*1000, 2) },   title: 'Maximum time in milliseconds a waiting session spent since start of last wait', align: :right }

  caption = "#{@role.to_s.capitalize} sessions for event combination '#{@blocking_event}' -> '#{@waiting_event}' between #{@time_selection_start} and #{@time_selection_end}"

  @hidden_link_timeline_id = get_unique_area_id

  context_menu_entries = []
  command_menu_entries = [get_recall_params_info_for_render_page_caption]

  def create_context_menu_entry(seconds, context_menu_entries, command_menu_entries, icon_class)
    label   = t(:active_session_history_show_top_ten, :sec=>seconds, :default=>"Show Top 10 in time chart, condensed by %{sec} seconds")
    hint    = t(:active_session_history_show_top_ten_hint, :sec=>seconds, :default=>"Show Top 10 ordered by total time waited in time chart, each point in graph for sum over %{sec} seconds")
    action  = "$('##{@hidden_link_timeline_id}_#{seconds}').click();"

    context_menu_entries << {
        :label   => label,
        :hint    => hint,
        :ui_icon => icon_class,
        :action  => action
    }

    command_menu_entries << {
        name:                 "command_menu_timeline_#{seconds}",
        caption:              label,
        hint:                 hint,
        icon_class:           icon_class,
        show_icon_in_caption: true,
        action:               action
    }
  end

  create_context_menu_entry(60, context_menu_entries, command_menu_entries, 'cuis-chart-area')
  create_context_menu_entry(10, context_menu_entries, command_menu_entries, 'cui-chart-area')
  create_context_menu_entry(1, context_menu_entries, command_menu_entries,  'cui-chart-line')

  @link_timeline = proc do |group_seconds|
    ajax_link("Hidden Auslöser für Timeline",
              {action:                :blocking_locks_historic_event_dependency_timechart,
               dbid:                  @dbid,
               time_selection_start:  @time_selection_start,
               time_selection_end:    @time_selection_end,
               group_seconds:         group_seconds,
               update_area:           @update_area_timechart
              },
              :style=>"display:none",
              :id=>"#{@hidden_link_timeline_id}_#{group_seconds}"
    )
  end

%>

<%= gen_slickgrid(@sessions, column_options, {
    caption:              caption,
    max_height:           450,
    context_menu_entries: context_menu_entries,
    command_menu_entries: command_menu_entries,
    show_pin_icon:        1,
    direct_update_area:   @update_area_timechart,
    update_area:          @update_area
}) %>

<%= @link_timeline.call(60) %>
<%= @link_timeline.call(10) %>
<%= @link_timeline.call( 1) %>
