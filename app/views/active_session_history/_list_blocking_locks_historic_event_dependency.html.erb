<%
  @update_area            = get_unique_area_id
  @update_area_timechart  = get_unique_area_id

  link_blocking_sessions = proc do |rec|
    "<&nbsp;#{fn(rec.blocking_sessions)}&nbsp;>".html_safe
  end

  link_waiting_sessions = proc do |rec|
    "<&nbsp;#{fn(rec.waiting_sessions)}&nbsp;>".html_safe
  end

  link_column_samples = proc do |rec|
    ajax_link(fn(rec.samples), {
        :action           => :list_session_statistic_historic_single_record,
        :update_area      => @update_area,
        :groupfilter      => {
            Blocking_Event:           rec.blocking_event,
            Event:                    rec.waiting_event,
            DBID:                     @dbid,
            time_selection_start:     @time_selection_start,
            time_selection_end:       @time_selection_end,
        }
    }, title: "Show ASH records for this combination of blocking and waiting event"
    )
  end


  column_options =
      [
          {caption: 'Blocking event',         data: proc{|rec| rec.blocking_event },                    title: 'Event of sessions that are blocking other sessions', data_title: proc{|rec| "%t\n\n#{explain_wait_event(rec.blocking_event)}"} },
          {caption: 'Blocking sessions',      data: link_blocking_sessions,                             title: 'Number of distinct sessions (Instance, SID, Serial#) that are blocking other sessions', align: :right },
          {caption: 'Blocking active (sec.)', data: proc{|rec| fn(rec.blocking_active_seconds) },       title: 'Total number of seconds all blocking sessions have been active (or blocked themself)', data_title: proc{|rec| "%t\n#{seconds_explain(rec.blocking_active_seconds)}"}, align: :right },
          {caption: 'Waiting event',          data: proc{|rec| rec.waiting_event },                     title: 'Event of sessions that are blocked by other sessions', data_title: proc{|rec| "%t\n\n#{explain_wait_event(rec.waiting_event)}"} },
          {caption: 'Waiting sessions',       data: link_waiting_sessions,                              title: 'Number of distinct sessions (Instance, SID, Serial#) that are blocked by other sessions', align: :right },
          {caption: 'Waiting active (sec.)',  data: proc{|rec| fn(rec.waiting_active_seconds) },        title: 'Total number of seconds all waiting sessions have been blocked by blocking sessions', data_title: proc{|rec| "%t\n#{seconds_explain(rec.waiting_active_seconds)}"}, align: :right, show_pct_hint: true, show_pct_background: true},
          {caption: 'First ASH sample',       data: proc{|rec| localeDateTime(rec.first_occurrence) },  title: 'First occurrence of ASH sample for blocked waiting session'},
          {caption: 'Last ASH sample',        data: proc{|rec| localeDateTime(rec.last_occurrence) },   title: 'Last occurrence of ASH sample for blocked waiting session'},
          {caption: 'Samples',                data: link_column_samples,                                title: 'Number of ASH samples for waiting sessions between first and last occurrence of ASH sample', align: :right },
          {caption: 'Avg. waiting sessions',  data: proc{|rec| fn(rec.avg_waiting_sessions, 1) },       title: 'Average number of waiting sessions between first and last occurrence of ASH sample', align: :right },
          {caption: 'Avg. ms per wait',       data: proc{|rec| fn(rec.avg_seconds_in_wait*1000, 2) },   title: 'Average time in milliseconds the waiting sessions spent since start of last wait', align: :right },
          {caption: 'Min. ms per wait',       data: proc{|rec| fn(rec.min_seconds_in_wait*1000, 2) },   title: 'Minimum time in milliseconds a waiting session spent since start of last wait', align: :right },
          {caption: 'Max. ms per wait',       data: proc{|rec| fn(rec.max_seconds_in_wait*1000, 2) },   title: 'Maximum time in milliseconds a waiting session spent since start of last wait', align: :right },
      ]

  caption = "Event combinations for waiting and blocking sessions between #{@time_selection_start} and #{@time_selection_end}"

  @hidden_link_timeline_id = get_unique_area_id

  context_menu_entries = []
  command_menu_entries = [get_recall_params_info_for_render_page_caption]

  def create_context_menu_entry(seconds, context_menu_entries, command_menu_entries, icon_class)
    label   = t(:active_session_history_show_top_ten, :sec=>seconds, :default=>"Show Top 10 in time chart, condensed by %{sec} seconds")
    hint    = t(:active_session_history_show_top_ten_hint, :sec=>seconds, :default=>"Show Top 10 ordered by total time waited in time chart, each point in graph for sum over %{sec} seconds")
    action  = "$('##{@hidden_link_timeline_id}_#{seconds}').click();"

    context_menu_entries << {
        :label   => label,
        :hint    => hint,
        :ui_icon => icon_class,
        :action  => action
    }

    command_menu_entries << {
        name:                 "command_menu_timeline_#{seconds}",
        caption:              label,
        hint:                 hint,
        icon_class:           icon_class,
        show_icon_in_caption: true,
        action:               action
    }
  end

  create_context_menu_entry(60, context_menu_entries, command_menu_entries, 'cuis-chart-area')
  create_context_menu_entry(10, context_menu_entries, command_menu_entries, 'cui-chart-area')
  create_context_menu_entry(1, context_menu_entries, command_menu_entries,  'cui-chart-line')

  @link_timeline = proc do |group_seconds|
    ajax_link("Hidden Auslöser für Timeline",
              {action:                :blocking_locks_historic_event_dependency_timechart,
               dbid:                  @dbid,
               time_selection_start:  @time_selection_start,
               time_selection_end:    @time_selection_end,
               group_seconds:         group_seconds,
               update_area:           @update_area_timechart
              },
              :style=>"display:none",
              :id=>"#{@hidden_link_timeline_id}_#{group_seconds}"
    )
  end

%>

<%= gen_slickgrid(@event_locks, column_options, {
    caption:              caption,
    max_height:           450,
    context_menu_entries: context_menu_entries,
    command_menu_entries: command_menu_entries,
    show_pin_icon:        1,
    direct_update_area:   @update_area_timechart,
    update_area:          @update_area
}) %>

<%= @link_timeline.call(60) %>
<%= @link_timeline.call(10) %>
<%= @link_timeline.call( 1) %>
